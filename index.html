<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í€´ì¦ˆ ì‹œìŠ¤í…œ (ì‚¬ì§„ í¬í•¨)</title>
<style>
:root{
  --accent:#68a0ff;
  --stop:#ff8c42;
  --card-radius:10px;
}
body{
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 12px;
  background:#fafafa;
  color:#111;
}
.container{ max-width:980px; margin:0 auto; }
h1{ font-size:1.4rem; margin:6px 0 12px; }

/* controls */
.controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
.controls select, .controls button { padding:10px; font-size:1rem; border-radius:8px; border:1px solid #ddd; background:white; }
.controls .spacer{ flex:1; }

/* status */
#statusBar{ margin-top:8px; font-weight:600; font-size:0.95rem; }

/* question area */
#questionArea{
  margin-top:12px;
  background:white;
  border-radius:12px;
  padding:14px;
  box-shadow:0 1px 6px rgba(0,0,0,0.04);
}

/* stop button wrapper (ìœ„ì¹˜: ë¬¸ì œ ìœ„) */
.stop-wrapper{ margin:10px 0 6px; display:flex; justify-content:flex-end; }
#stopBtn{ background:var(--stop); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
#stopBtn:hover{ background:#ff7a22; }

/* question text + image */
#qText{ font-weight:700; font-size:1.05rem; }
#questionImage{ display:block; width:100%; max-height:380px; object-fit:contain; margin-top:12px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.08); }

/* option cards */
.options{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.question-card{
  border:1px solid #e2e8f0;
  background:white;
  padding:12px;
  border-radius:10px;
  cursor:pointer;
  transition:transform .08s, background .12s;
  text-align:left;
}
.question-card:hover{ transform:translateY(-3px); background:#f7fbff; }

/* answer box */
#answerBox{
  margin-top:12px;
  background:white;
  border-radius:10px;
  padding:12px;
  border:1px solid #eee;
  min-height:120px;
}

/* inputs */
#textAnswerBox{ width:100%; padding:10px; margin-top:8px; box-sizing:border-box; border-radius:8px; border:1px solid #ddd; font-size:1rem; }
.controls .btn-primary{ background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
.controls .btn-ghost{ background:white; border:1px solid #ddd; padding:10px 12px; border-radius:8px; cursor:pointer; }

/* misc */
.correct{ color:green; font-weight:700; }
.wrong{ color:#d43f3f; font-weight:700; }

/* mini mode highlight */
.mini-mode .question-card,
.mini-mode #answerBox{ background:#fffbe6 !important; }

/* responsive */
@media (max-width:720px){
  .controls{ flex-direction:column; align-items:stretch; }
  #questionImage{ max-height:260px; }
}
</style>
</head>
<body>
<div class="container">
  <h1>í€´ì¦ˆ ì‹œìŠ¤í…œ</h1>

  <div class="controls">
    <select id="subjectSelect"><option value="">ê³¼ëª© ì„ íƒ</option></select>
    <select id="themeSelect"><option value="">í…Œë§ˆ ì„ íƒ</option></select>
    <div class="spacer"></div>
    <button id="miniTestBtn" class="btn-primary">ğŸ”¥ Mini Test (ê³¼ëª©ë³„ 10ë¬¸ì œ)</button>
    <button id="resetBtn" class="btn-ghost" style="display:none;">ğŸ”„ ë¦¬ì…‹</button>
  </div>

  <div id="statusBar"></div>

  <!-- ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ë²„íŠ¼ (ë¬¸ì œ ì˜ì—­ ìœ„) -->
  <div class="stop-wrapper">
    <button id="stopBtn" style="display:none;">ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ã…œã…œ</button>
  </div>

  <div id="questionArea">
    <div id="qText"></div>
    <img id="questionImage" style="display:none;" alt="question image" />
    <div id="optionsArea" class="options"></div>

    <input id="textAnswerBox" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="display:none;" />
    <div style="margin-top:10px;">
      <button id="submitBtn" class="btn-primary" style="display:none;">ì œì¶œ</button>
      <button id="nextBtn" class="btn-ghost">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>
  </div>

  <div id="answerBox"></div>
</div>

<script>
/* ---------- ì„¤ì • ---------- */
const jsonURL = "https://kangroo1209-alt.github.io/quizyquiz/output.json";
const imageExtRe = /\.(jpg|jpeg|png|gif|bmp|webp)$/i;

/* ---------- ìƒíƒœ ---------- */
let quizData = [];
let currentSubject = "";
let currentTheme = "";
let currentQuestion = null;
let usedQuestions = new Set();

let solvedCount = 0, totalCount = 0;

let miniMode = false;
let miniList = [], miniIndex = 0, miniWrong = [], miniTotal = 0;

/* ---------- DOM ---------- */
const subjectSelect = document.getElementById("subjectSelect");
const themeSelect = document.getElementById("themeSelect");
const statusBar = document.getElementById("statusBar");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const miniTestBtn = document.getElementById("miniTestBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const qText = document.getElementById("qText");
const questionImage = document.getElementById("questionImage");
const optionsArea = document.getElementById("optionsArea");
const textAnswerBox = document.getElementById("textAnswerBox");
const answerBox = document.getElementById("answerBox");

/* ---------- ë°ì´í„° ë¡œë“œ ---------- */
fetch(jsonURL).then(r=>r.json()).then(data=>{
  quizData = data || [];
  renderSubjects();
}).catch(e=>{
  console.error("JSON ë¡œë“œ ì‹¤íŒ¨:", e);
  quizData = [];
  renderSubjects();
});

/* ---------- UI í—¬í¼ ---------- */
function applyMiniModeUI(on){
  if(on) document.body.classList.add("mini-mode"); else document.body.classList.remove("mini-mode");
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

/* ---------- ê³¼ëª©/í…Œë§ˆ ë Œë” ---------- */
function renderSubjects(){
  const subs = [...new Set(quizData.map(q=>q.subject))];
  subjectSelect.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ</option>' + subs.map(s=>`<option>${s}</option>`).join('');
}
subjectSelect.addEventListener("change",()=>{
  currentSubject = subjectSelect.value;
  renderThemes();
  resetNormal();
});
function renderThemes(){
  if(!currentSubject){ themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>'; return; }
  const themes = [...new Set(quizData.filter(q=>q.subject===currentSubject).map(q=>q.theme))];
  themeSelect.innerHTML = '<option value="">í…Œë§ˆ ì„ íƒ</option>' + themes.map(t=>`<option>${t}</option>`).join('');
}
themeSelect.addEventListener("change",()=>{
  currentTheme = themeSelect.value;
  miniMode = false;
  applyMiniModeUI(false);
  resetNormal();
  renderQuestion();
});

/* ---------- ìƒíƒœë°” ---------- */
function updateStatusBar(){
  if(miniMode){
    const sub = miniList[miniIndex] ? miniList[miniIndex].subject : "";
    statusBar.innerHTML = `ğŸ”¥ Mini Test ì§„í–‰ì¤‘ Â· í˜„ì¬ ê³¼ëª©: ${sub} Â· ${miniIndex}/${miniTotal}`;
    return;
  }
  if(currentSubject && currentTheme){
    statusBar.innerHTML = `ğŸ“˜ ${currentSubject} / ${currentTheme} Â· í‘¼ë¬¸ì œ: ${solvedCount}/${totalCount}`;
    return;
  }
  statusBar.innerHTML = "";
}

/* ---------- ë¦¬ì…‹(ì¼ë°˜ëª¨ë“œ) ---------- */
function resetNormal(){
  usedQuestions.clear();
  solvedCount = 0;
  const list = quizData.filter(q=>q.subject===currentSubject && q.theme===currentTheme);
  totalCount = list.length;
  updateStatusBar();
  answerBox.innerHTML = "";
  clearQuestionUI();
  resetBtn.style.display = (currentSubject && currentTheme) ? "inline-block" : "none";
}
resetBtn.addEventListener("click", resetNormal);

/* ---------- ì •ë‹µ ê°€ì ¸ì˜¤ê¸° (subject/theme ê¸°ë°˜) ---------- */
function getCorrectAnswersFor(qText, subj=currentSubject, theme=currentTheme){
  return [...new Set( quizData.filter(i=> i.subject===subj && i.theme===theme && i.question===qText ).map(i=>i.answer) )];
}

/* ---------- ë¬¸ì œ ë‚´ê¸° (ì¼ë°˜ëª¨ë“œ) ---------- */
function renderQuestion(){
  if(!currentSubject || !currentTheme){
    clearQuestionUI(); qText.innerHTML = "<p>ê³¼ëª©ê³¼ í…Œë§ˆë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>"; return;
  }
  const list = quizData.filter(q=>q.subject===currentSubject && q.theme===currentTheme);
  const remain = list.filter(q=>!usedQuestions.has(q.question));
  if(remain.length === 0){ clearQuestionUI(); qText.innerHTML = "<p>ğŸ‰ ëª¨ë“  ë¬¸ì œ ì™„ë£Œ!</p>"; return; }
  const q = remain[Math.floor(Math.random()*remain.length)];
  currentQuestion = q;
  usedQuestions.add(q.question);
  solvedCount++;
  updateStatusBar();
  renderQuestionCard(q);
}

/* ---------- UI ì´ˆê¸°í™” ---------- */
function clearQuestionUI(){
  qText.innerHTML = "";
  questionImage.style.display = "none";
  optionsArea.innerHTML = "";
  textAnswerBox.style.display = "none";
  submitBtn.style.display = "none";
}

/* ---------- ë¬¸ì œ ë Œë”(í…ìŠ¤íŠ¸/ê°ê´€ì‹/ê³„ì‚°/ì‚¬ì§„ í†µí•©) ---------- */
function renderQuestionCard(q){
  const correctList = getCorrectAnswersFor(q.question, q.subject, q.theme);
  const mainAnswer = correctList[0];

  // ì´ˆê¸°í™”
  clearQuestionUI();
  answerBox.innerHTML = "";

  const themeKey = (q.theme||"").toString().toLowerCase();
  const isPhotoTheme = themeKey === "photo" || themeKey === "ì‚¬ì§„" || imageExtRe.test(String(q.question||""));
  const isCalc = themeKey === "calc" || themeKey === "ê³„ì‚°";

  if(isPhotoTheme){
    qText.innerHTML = `<b>ë¬¸ì œ:</b> ì‚¬ì§„ì„ ë³´ê³  ì •ë‹µì„ ê³ ë¥´ì„¸ìš”.`;
    const imgPath = `images/${encodeURIComponent(q.subject)}/${encodeURIComponent(q.question)}`;
    questionImage.src = imgPath;
    questionImage.style.display = "block";

    // í›„ë³´: ê°™ì€ subject+themeì˜ answerë“¤
    let candidates = quizData.filter(i=> i.subject===q.subject && i.theme===q.theme && i.answer!==mainAnswer ).map(i=>i.answer);
    candidates = [...new Set(candidates)];
    let wrongs = shuffle(candidates).slice(0,4);

    // í›„ë³´ ë¶€ì¡± ì‹œ ë³´ì™„: ê°™ì€ subject ë‚´ ë‹¤ë¥¸ themeì—ì„œ ë½‘ê¸°
    if(wrongs.length < 4){
      const backup = [...new Set( quizData.filter(i=> i.subject===q.subject && i.answer!==mainAnswer).map(i=>i.answer) )].filter(x=>!wrongs.includes(x));
      wrongs = wrongs.concat(shuffle(backup).slice(0, 4 - wrongs.length));
    }

    const answers = shuffle([mainAnswer, ...wrongs]).slice(0, Math.min(5, 1 + wrongs.length));
    answers.forEach(ans=>{
      const d = document.createElement("div");
      d.className = "question-card";
      d.textContent = ans;
      d.onclick = ()=> showAnswerResult(ans === mainAnswer, mainAnswer, correctList);
      optionsArea.appendChild(d);
    });
    return;
  }

  if(isCalc){
    qText.innerHTML = `<b>ë¬¸ì œ:</b> ${q.question}`;
    textAnswerBox.style.display = "block";
    submitBtn.style.display = "inline-block";
    submitBtn.onclick = ()=>{
      const user = textAnswerBox.value.trim();
      const isCorrect = compareAnswer(user, mainAnswer);
      showAnswerResult(isCorrect, mainAnswer, correctList);
      textAnswerBox.value = "";
      // ì¼ë°˜ ëª¨ë“œì¼ ê²½ìš° ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ì§„í–‰
      if(!miniMode){
        setTimeout(()=>{ renderQuestion(); }, 200);
      }
    };
    return;
  }

  // ê¸°ë³¸ ê°ê´€ì‹: ê°™ì€ subject+themeì˜ ë‹¤ë¥¸ answer ì‚¬ìš©
  qText.innerHTML = `<b>ë¬¸ì œ:</b> ${q.question}`;
  let others = quizData.filter(i=> i.subject===q.subject && i.theme===q.theme && i.question !== q.question).map(i=>i.answer);
  others = [...new Set(others)];
  let picks = shuffle(others).slice(0,4);
  const options = shuffle([mainAnswer, ...picks]).slice(0, Math.min(5, 1 + picks.length));
  options.forEach(opt=>{
    const d = document.createElement("div");
    d.className = "question-card";
    d.textContent = opt;
    d.onclick = ()=> showAnswerResult(opt === mainAnswer, mainAnswer, correctList);
    optionsArea.appendChild(d);
  });
}

/* ---------- ì •ë‹µ ê²°ê³¼ í‘œì‹œ ë° ë¯¸ë‹ˆì§„í–‰ ---------- */
function showAnswerResult(isCorrect, mainAnswer, correctList){
  if(isCorrect){
    answerBox.innerHTML = `<p class="correct">ì •ë‹µì…ë‹ˆë‹¤!</p><p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctList.join(", ")}</p>`;
  } else {
    answerBox.innerHTML = `<p class="wrong">ì˜¤ë‹µì…ë‹ˆë‹¤!</p><p>ì •ë‹µ: ${mainAnswer}</p><p>ë‹¤ë¥¸ ì •ë‹µë“¤: ${correctList.join(", ")}</p>`;
  }
  handleMiniProgress(isCorrect);
}

/* ---------- ìˆ«ì/ë¬¸ì ë¹„êµ ---------- */
function compareAnswer(user, correct){
  if(!isNaN(user) && !isNaN(correct)) return parseFloat(user) === parseFloat(correct);
  return String(user).trim() === String(correct).trim();
}

/* ---------- ë‹¤ìŒ ë²„íŠ¼(ì¼ë°˜) ---------- */
nextBtn.addEventListener("click", ()=> {
  if(!miniMode){
    // ê³„ì‚°ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ì œì¶œ í´ë¦­ íŠ¸ë¦¬ê±° (submitBtnì´ visibleí•  ë•Œ)
    if(textAnswerBox.style.display !== "none" && submitBtn.style.display !== "none"){
      submitBtn.click();
      return;
    }
    renderQuestion();
  }
});

/* ---------- Mini Test ---------- */
miniTestBtn.addEventListener("click", startMiniTest);
function startMiniTest(){
  if(!currentSubject){ alert("ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  miniMode = true; applyMiniModeUI(true);
  nextBtn.style.display = "none"; stopBtn.style.display = "inline-block";
  usedQuestions.clear(); miniWrong = []; miniIndex = 0; miniList = [];

  // ê³¼ëª©ë³„ë¡œ ìµœëŒ€ 10ê°œì”© ë½‘ìŒ
  const subs = [...new Set(quizData.map(q=>q.subject))];
  subs.forEach(sub=>{
    const pool = quizData.filter(q=> q.subject === sub);
    let pick = [];
    while(pick.length < 10 && pool.length > 0){
      const i = Math.floor(Math.random() * pool.length);
      pick.push(pool[i]); pool.splice(i,1);
    }
    miniList = miniList.concat(pick);
  });
  miniTotal = miniList.length;
  updateStatusBar();
  renderMiniQuestion();
}

function renderMiniQuestion(){
  if(miniIndex >= miniTotal){ showMiniResult(); return; }
  const q = miniList[miniIndex];
  currentQuestion = q;
  // ì„ì‹œë¡œ currentSubject/currentTheme ì„¸íŒ… (ì¤‘ìš”)
  currentSubject = q.subject; currentTheme = q.theme;
  renderQuestionCard(q);
  updateStatusBar();
}

function handleMiniProgress(isCorrect){
  if(miniMode){
    if(!isCorrect){
      miniWrong.push({
        question: currentQuestion.question,
        correct: getCorrectAnswersFor(currentQuestion.question, currentQuestion.subject, currentQuestion.theme)
      });
    }
    miniIndex++;
    setTimeout(renderMiniQuestion, 400);
  }
}

/* ---------- ì—¬ê¸°ê¹Œì§€ë§Œ í’€ê¸° ---------- */
stopBtn.addEventListener("click", ()=>{
  miniMode = false; applyMiniModeUI(false);
  showMiniResult();
});

/* ---------- Mini ê²°ê³¼ ---------- */
function showMiniResult(){
  nextBtn.style.display = "inline-block"; stopBtn.style.display = "none";
  const totalSolved = miniIndex;
  const wrongCount = miniWrong.length;
  const correctCount = totalSolved - wrongCount;
  let html = `<h2>Mini Test ì™„ë£Œ!</h2>`;
  html += `<p>ì´ í‘¼ ë¬¸ì œ: ${totalSolved}</p><p>ì •ë‹µ: ${correctCount}</p><p>ì˜¤ë‹µ: ${wrongCount}</p>`;
  if(wrongCount>0){
    html += `<h3>í‹€ë¦° ë¬¸ì œë“¤</h3>`;
    miniWrong.forEach(w=>{
      html += `<p><b>${w.question}</b><br>ì •ë‹µ: ${w.correct.join(", ")}</p><hr>`;
    });
  }
  qText.innerHTML = html;
  questionImage.style.display = "none";
  optionsArea.innerHTML = "";
  answerBox.innerHTML = "";
  statusBar.innerHTML = "";
  applyMiniModeUI(false);
}

/* ---------- shuffle util ---------- */
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
</script>
</body>
</html>
